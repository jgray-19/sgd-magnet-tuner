title, "LHC Model created by omc3";
! Model directory        /afs/cern.ch/work/j/jmgray/private/dpp_corr
! Acc-Models             /afs/cern.ch/eng/acc-models/lhc/2025
! LHC year               2025
! Natural Tune X             62.280
! Natural Tune Y             60.310
! Best Knowledge                 NO
! Excitation                    ACD
! > Driven Tune X            62.270
! > Driven Tune Y            60.322


call, file = 'macros/general.macros.madx';
call, file = 'macros/lhc.macros.madx';
omc3_beam_energy = 450.0;
exec, define_nominal_beams();

call, file = 'macros/lhc.macros.run3.madx';

! ----- Calling Sequence -----
option, -echo;  ! suppress output from base sequence loading to keep the log small
call, file = '/afs/cern.ch/eng/acc-models/lhc/2025/lhc.seq';
option, echo;  ! re-enable output to see the optics settings

! ---- Call optics and other modifiers ----
call, file = '/afs/cern.ch/work/j/jmgray/private/dpp_corr/acc-models-lhc/operation/optics/R2025aRP_A18cmC18cmA10mL200cm_Flat.madx'; !@modifier

! ----- Remove IR symmetry definitions -----

call, file="/afs/cern.ch/eng/acc-models/lhc/2025/toolkit/remove-triplet-symmetry-knob.madx"; ! removes 'ktqx.r1 := -ktqx.l1'-type issues

! ----- Finalise Sequence -----
exec, cycle_sequences();
use, sequence = LHCB1;
exec, match_tunes(62.28, 60.31, 1);
exec, coupling_knob(1);
select, flag=twiss, clear;
select, flag=twiss, pattern='BPM.*', column=NAME,S,BETX,ALFX,BETY,ALFY,DX,DY,DPX,DPY,X,Y,K1L,MUX,MUY,R11,R12,R21,R22;

orbit_dpp = 0.0;
twiss, deltap=orbit_dpp;
correct, mode=svd;

! The same as match_tunes, but include deltap in the matching
exec, find_complete_tunes(62.28, 60.31, 1);
match, deltap=orbit_dpp;
vary, name=dQx.b1_op;
vary, name=dQy.b1_op;
constraint, range=#E, mux=total_qx, muy=total_qy;
lmdif, tolerance=1e-10;
endmatch;
twiss, file='/afs/cern.ch/work/j/jmgray/private/dpp_corr/model_b1__t0.28_0.31_18cm/twiss.0', deltap=orbit_dpp;

! usekick, status=off, range=#s/#e;
! usekick, status=on, pattern='^mcb[hv]\..*$';
! usekick, status=on, pattern='^mcbc[hv]\..*$';
! usekick, status=on, pattern='^mcby[hv]\..*$';
! usekick, status=on, pattern='^mcbxh\.1l1.*$';
! usekick, status=on, pattern='^mcbxh\.2l5.*$';
! usekick, status=on, pattern='^mcbxh\.1l5.*$';

! orbit_dpp = orbit_dpp-3e-5;
! twiss, deltap=orbit_dpp;
! correct, mode=svd, CLIST='correctors_b1.tfs';

! ! The same as match_tunes, but include deltap in the matching
! exec, find_complete_tunes(62.28, 60.31, 1);
! match, deltap=orbit_dpp;
! vary, name=dQx.b1_op;
! vary, name=dQy.b1_op;
! constraint, range=#E, mux=total_qx, muy=total_qy;
! lmdif, tolerance=1e-10;
! endmatch;
! twiss, deltap=orbit_dpp, file='/afs/cern.ch/work/j/jmgray/private/dpp_corr/model_b1__t0.28_0.31_18cm/twiss.orbit_dpp';

value, kqtf.a23b1;
value, kqtd.a23b1;
value, kqtd.a34b1;
value, kqtf.a34b1;
value, kqtf.a67b1;
value, kqtd.a67b1;
value, kqtd.a78b1;
value, kqtf.a78b1;